---
layout: default
title: 架構概覽
---

<div class="doc-layout">
    <aside class="doc-sidebar">
        <nav class="sidebar-nav">
            <h4 class="sidebar-title">本頁目錄</h4>
            <ul class="sidebar-links">
                <li><a href="#overview" class="sidebar-link">架構概覽</a></li>
                <li><a href="#layers" class="sidebar-link">分層設計</a></li>
                <li><a href="#memory-layout" class="sidebar-link">記憶體佈局</a></li>
                <li><a href="#directory" class="sidebar-link">目錄結構</a></li>
                <li><a href="#build-system" class="sidebar-link">建構系統</a></li>
                <li><a href="#configuration" class="sidebar-link">配置系統</a></li>
                <li><a href="#ble-controller" class="sidebar-link">BLE 控制器</a></li>
                <li><a href="#components" class="sidebar-link">元件概覽</a></li>
            </ul>
        </nav>
    </aside>

    <article class="doc-content">
        <h1>架構概覽</h1>
        <p>IPRO SDK 採用清晰的分層架構設計，提供高度模組化與可移植性，讓開發者能夠快速建構穩定的嵌入式應用。</p>

        <section id="overview">
            <h2>系統架構圖</h2>
            <p>SDK 的整體架構由五個主要層次組成：</p>

            <div class="code-block">
                <div class="code-block-header">
                    <span class="code-block-title">IPRO SDK 架構</span>
                </div>
                <pre><code>+------------------------------------------------------+
|                 Application Layer                    |
|              (e.g., apps/ipro7_demo)                 |
+------------------------------------------------------+
|          Middleware & Reusable Components            |
|   (lwIP, Mbed TLS, CherryUSB, File Systems, etc.)    |
+------------------------------------------------------+
|       Real-Time OS (FreeRTOS or Zephyr RTOS)        |
+------------------------------------------------------+
|             Board Support Package (BSP)              |
|   +----------------------------------------------+   |
|   | Hardware Abstraction Layer (HAL) & Drivers   |   |
|   +----------------------------------------------+   |
+------------------------------------------------------+
|               IPRO Hardware Platform                 |
+------------------------------------------------------+</code></pre>
            </div>
        </section>

        <section id="layers">
            <h2>各層詳細說明</h2>

            <h3>應用層（Application Layer）</h3>
            <p>位於 <code>apps/</code> 目錄，包含所有的應用程式專案。每個應用都是獨立的專案，擁有自己的：</p>
            <ul>
                <li><code>CMakeLists.txt</code> - 建構配置</li>
                <li><code>proj.conf</code> - Kconfig 配置覆蓋</li>
                <li><code>main.c</code> - 應用程式入口</li>
                <li><code>Kconfig.app</code> - 應用專屬選項</li>
            </ul>

            <h3>中間件層（Middleware Layer）</h3>
            <p>位於 <code>components/</code> 目錄，提供可重複使用的軟體元件：</p>

            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>元件</th>
                            <th>目錄</th>
                            <th>功能</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>lwIP</td>
                            <td><code>components/network/</code></td>
                            <td>輕量級 TCP/IP 協定棧</td>
                        </tr>
                        <tr>
                            <td>Mbed TLS</td>
                            <td><code>components/crypto/</code></td>
                            <td>加密與安全通訊</td>
                        </tr>
                        <tr>
                            <td>CherryUSB</td>
                            <td><code>components/cherryusb/</code></td>
                            <td>USB 裝置/主機協定棧</td>
                        </tr>
                        <tr>
                            <td>Wireless</td>
                            <td><code>components/wireless/</code></td>
                            <td>BLE 5.4、Zigbee、Thread</td>
                        </tr>
                        <tr>
                            <td>File Systems</td>
                            <td><code>components/fs/</code></td>
                            <td>FAT、LittleFS 等檔案系統</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <h3>RTOS 層</h3>
            <p>SDK 支援兩種即時作業系統：</p>
            <ul>
                <li><strong>FreeRTOS</strong> - 位於 <code>components/os/freertos/</code>，經典穩定的 RTOS 選擇</li>
                <li><strong>Zephyr RTOS</strong> - 現代化 RTOS，提供 Device Tree、West 建構系統等進階功能</li>
            </ul>

            <h3>BSP 層（Board Support Package）</h3>
            <p>位於 <code>bsp/</code> 目錄，提供硬體抽象：</p>
            <ul>
                <li><code>bsp/hal/</code> - 硬體抽象層 API</li>
                <li><code>bsp/drivers/</code> - 週邊驅動程式</li>
                <li><code>bsp/board/</code> - 板級配置</li>
            </ul>

            <h4>支援的週邊驅動</h4>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>類別</th>
                            <th>驅動</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>通訊介面</td>
                            <td>UART, SPI (主/從), I2C, I2S</td>
                        </tr>
                        <tr>
                            <td>儲存</td>
                            <td>SD 卡 (SDH), SPI Flash, PSRAM</td>
                        </tr>
                        <tr>
                            <td>顯示</td>
                            <td>LCD (ILI9488 SPI), OSD blend/draw</td>
                        </tr>
                        <tr>
                            <td>音訊</td>
                            <td>AUADC, DAC, I2S</td>
                        </tr>
                        <tr>
                            <td>多媒體</td>
                            <td>ISP 攝影機, DVP sensor, MJPEG 編解碼</td>
                        </tr>
                        <tr>
                            <td>網路</td>
                            <td>EMAC 乙太網</td>
                        </tr>
                        <tr>
                            <td>USB</td>
                            <td>Device (CDC, MSC, HID, UAC, UVC)</td>
                        </tr>
                        <tr>
                            <td>其他</td>
                            <td>GPIO, PWM, ADC, Timer, IR, QDEC, DMA</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <section id="memory-layout">
            <h2>記憶體佈局（IPRO7）</h2>
            <p>IPRO7 採用 RISC-V <code>rv32imafc</code> / <code>ilp32f</code> 架構，處理器運行頻率 192MHz。記憶體佈局如下：</p>

            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>區域</th>
                            <th>大小</th>
                            <th>起始位址</th>
                            <th>用途</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Flash</td>
                            <td>4 MB</td>
                            <td><code>0x00000000</code></td>
                            <td>程式碼與唯讀資料儲存</td>
                        </tr>
                        <tr>
                            <td>PSRAM</td>
                            <td>16 MB</td>
                            <td><code>0x20000000</code></td>
                            <td>主要 RAM（堆積、資料段）</td>
                        </tr>
                        <tr>
                            <td>OCRAM</td>
                            <td>256 KB</td>
                            <td><code>0x60000000</code></td>
                            <td>高速 SRAM（堆疊、關鍵程式碼）</td>
                        </tr>
                        <tr>
                            <td>HBNRAM</td>
                            <td>4 KB</td>
                            <td><code>0x50000000</code></td>
                            <td>休眠保持 RAM</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <section id="directory">
            <h2>目錄結構</h2>

            <div class="code-block">
                <div class="code-block-header">
                    <span class="code-block-title">SDK 目錄結構</span>
                </div>
                <pre><code>ipro_sdk/
├── apps/                         # 應用程式專案
│   ├── bluetooth/                # BLE 應用
│   │   ├── ipro_ble_remote/      # BLE 遙控器（GATT + OTA）
│   │   ├── ipro_throughput_test/ # BLE 效能測試（999 Kbps）
│   │   ├── ipro_walkie_talkie/   # BIS LE Audio 對講機
│   │   └── ipro_le_audio_headset/# GAF/BAP LE Audio 耳機
│   ├── ipro7_demo/               # 綜合平台展示
│   ├── ipro_unit_test/           # 單元測試
│   └── ipro_zephyr_demo/         # Zephyr 展示
│
├── bsp/                          # Board Support Package
│   ├── board/                    # 板級配置
│   ├── drivers/                  # 週邊驅動
│   ├── hal/                      # 硬體抽象層
│   └── common/                   # 共用程式碼
│
├── components/                   # 可重用元件（23 個分類）
│   ├── wireless/                 # 無線協定棧
│   │   └── bluetooth/            # BLE 5.4 棧
│   │       ├── blestack/         # Zephyr BLE Host（GAP/GATT/L2CAP/SMP）
│   │       ├── btblecontroller/  # 預建控制器函式庫（linkN 變體）
│   │       └── btprofile/        # 70+ BLE Profiles
│   ├── os/                       # RTOS 元件（FreeRTOS）
│   ├── network/                  # 網路協定棧（lwIP）
│   ├── crypto/                   # 加密元件（Mbed TLS）
│   ├── fs/                       # 檔案系統（LittleFS, FatFS）
│   ├── cherryusb/                # USB 裝置/主機協定棧
│   └── ...
│
├── tools/                        # 開發工具
│   ├── ipro_iot_tool_lite/       # 燒錄工具
│   ├── serial_monitor.py         # 串口監控（Python3）
│   ├── board_test.sh             # 自動化板級測試
│   ├── zephyr/                   # Zephyr 工具腳本
│   ├── vscode_extension/         # VS Code 擴充
│   └── cmake/                    # CI 用 CMake
│
├── cmake/                        # CMake 配置（toolchain.cmake 自動偵測）
├── kconfigs/                     # Kconfig 配置檔
│
├── build_freertos.sh             # FreeRTOS 建構腳本
├── CMakeLists.txt                # 根 CMake 配置
├── Kconfig                       # 根 Kconfig 配置
└── west.yml                      # Zephyr west 配置</code></pre>
            </div>
        </section>

        <section id="build-system">
            <h2>建構系統</h2>

            <h3>CMake + Ninja</h3>
            <p>SDK 使用 CMake 作為建構系統，搭配 Ninja 作為建構後端以獲得最佳效能。</p>

            <h4>建構流程</h4>
            <ol>
                <li><strong>配置階段</strong>：CMake 讀取 <code>CMakeLists.txt</code> 與 Kconfig，生成建構規則</li>
                <li><strong>建構階段</strong>：Ninja 執行編譯、連結，生成最終二進位檔</li>
            </ol>

            <div class="code-block">
                <div class="code-block-header">
                    <span class="code-block-title">建構命令參數說明</span>
                    <button class="code-copy-btn"><i class="fas fa-copy"></i></button>
                </div>
                <pre><code class="language-bash">cmake -S . -B build \
    -G "Ninja" \                      # 使用 Ninja 建構
    -DIPRO_SDK_BASE=$(pwd) \          # SDK 根目錄
    -DCONFIG_BUILD_PORJECT=app_name \ # 目標應用名稱
    -DCMAKE_PREFIX_PATH=$(pwd)/cmake \# CMake 模組路徑
    -DCUSTOM_CONFIG_DIR=path/to/app \ # 應用配置目錄
    -DCONFIG_APPS=1 \                 # 啟用應用建構
    -DCROSS_COMPILE=path/to/toolchain # 交叉編譯器前綴</code></pre>
            </div>

            <h3>West 建構系統（Zephyr）</h3>
            <p>Zephyr 專案使用 <code>west</code> 作為建構工具，提供更現代化的開發體驗。</p>

            <div class="code-block">
                <div class="code-block-header">
                    <span class="code-block-title">West 建構命令</span>
                    <button class="code-copy-btn"><i class="fas fa-copy"></i></button>
                </div>
                <pre><code class="language-bash"># 初始化 west workspace
west init -m https://github.com/your-org/ipro_sdk --mr main
west update

# 建構應用
west build -b ipro7_fpga apps/ipro_zephyr_demo

# 燒錄
west flash</code></pre>
            </div>
        </section>

        <section id="configuration">
            <h2>配置系統（Kconfig）</h2>
            <p>SDK 使用 Kconfig 系統管理專案配置，提供圖形化與文字介面配置選項。</p>

            <h3>配置層次</h3>
            <p>SDK 使用 Linux kernel 風格的 Kconfig 系統。每個應用擁有自己的 <code>.config</code> 檔案，包含 <code>CONFIG_*</code> 變數。建構時自動生成 <code>generated/autoconf.h</code>。</p>
            <ol>
                <li><strong>根配置</strong>：<code>Kconfig</code> - 定義所有可用選項</li>
                <li><strong>預設配置</strong>：<code>kconfigs/*.config</code> - 各功能模組的預設值</li>
                <li><strong>應用配置</strong>：<code>apps/*/.config</code> - 應用專屬配置</li>
            </ol>

            <h3>關鍵配置選項</h3>
            <div class="code-block">
                <div class="code-block-header">
                    <span class="code-block-title">.config 範例</span>
                    <button class="code-copy-btn"><i class="fas fa-copy"></i></button>
                </div>
                <pre><code class="language-bash"># SoC 選擇
CONFIG_IPRO7=y
CONFIG_CPU_ID="intelpro_ipro7"

# RTOS 選擇
CONFIG_FREERTOS_SUPPORT=y

# 無線功能
CONFIG_BLUETOOTH_LE_ENABLE=y

# 元件啟用
CONFIG_LWIP=y
CONFIG_MBEDTLS=y

# 測試自動執行
CONFIG_TEST_AUTO_RUN=y</code></pre>
            </div>

            <div class="alert alert-info">
                <strong>💡 提示：</strong><code>CONFIG_CPU_ID</code> 必須在 <code>.config</code> 中設定，工具鏈才能正確偵測架構旗標。<code>cmake/toolchain.cmake</code> 會自動偵測 vendor GCC（含 <code>_xxldsp</code> 擴充）與標準 GCC 並調整編譯旗標。
            </div>
        </section>

        <section id="ble-controller">
            <h2>BLE 控制器與預建函式庫</h2>

            <h3>BLE 棧架構</h3>
            <p>BLE 5.4 棧位於 <code>components/wireless/bluetooth/</code>，採用 Zephyr 風格回調式 GAP/GATT API：</p>
            <ul>
                <li><code>blestack/</code> - Zephyr BLE Host（GAP, GATT, L2CAP, SMP, ISO, LE Audio）- 可建構原始碼</li>
                <li><code>btblecontroller/</code> - RivieraWaves 控制器（預建 linkN 變體函式庫）</li>
                <li><code>btprofile/</code> - 70+ BLE Profiles</li>
                <li><code>blemesh/</code> - Bluetooth Mesh 支援（選用）</li>
            </ul>

            <h3>控制器變體（linkN 命名）</h3>
            <p>控制器使用統一連線池設計，以 <code>linkN</code> 命名（取代舊的 <code>mXsY</code> 命名）：</p>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>變體</th>
                            <th>BLE 版本</th>
                            <th>說明</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>link1_periph</code>, <code>link1</code>, <code>link2</code>, <code>link4</code>, <code>link8</code></td>
                            <td>BLE 5.0+</td>
                            <td>基礎 BLE，不同連線數</td>
                        </tr>
                        <tr>
                            <td><code>link1_leaudio</code>, <code>link2_leaudio</code></td>
                            <td>BLE 5.2</td>
                            <td>含 LE Audio 支援</td>
                        </tr>
                        <tr>
                            <td><code>link1_leaudio_53_54</code>, <code>link2_leaudio_53_54</code></td>
                            <td>BLE 5.4</td>
                            <td>含 LE Audio + BLE 5.3/5.4 功能</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <h3>預建函式庫系統</h3>
            <div class="code-block">
                <div class="code-block-header">
                    <span class="code-block-title">建構預建控制器函式庫</span>
                    <button class="code-copy-btn"><i class="fas fa-copy"></i></button>
                </div>
                <pre><code class="language-bash"># 建構指定變體
components/wireless/bluetooth/build_all_prebuilts.sh link2

# 建構所有變體
components/wireless/bluetooth/build_all_prebuilts.sh all

# 輸出位置：btblecontroller_ipro7_&lt;variant&gt;/libbtblecontroller_ipro7_&lt;variant&gt;.a</code></pre>
            </div>

            <div class="alert alert-warning">
                <strong>⚠️ 注意：</strong><code>CONFIG_BLE_FORCE_SOURCE_BUILD</code> 不可用於正式發布版本。正式版必須使用預建函式庫。
            </div>
        </section>

        <section id="components">
            <h2>主要元件概覽</h2>

            <h3>BLE 棧（Zephyr-based, BLE 5.4）</h3>
            <p>完整的 BLE 5.4 實作，應用使用 Zephyr 風格回調式 GAP/GATT API：</p>
            <ul>
                <li><strong>Host 層</strong>：GAP/GATT 管理、連線控制、安全管理（SMP）、L2CAP</li>
                <li><strong>Profile 層</strong>：70+ 標準 BLE Profiles</li>
                <li><strong>Audio 層</strong>：LE Audio（GAF, BAP, VCP, MCP, CAP）、LC3 編解碼</li>
                <li><strong>App Framework</strong>：Mediator（協調器）- Applets（可重用元件）- Intermediaries（協定橋接）</li>
            </ul>

            <h3>RTOS 元件</h3>
            <ul>
                <li><strong>FreeRTOS</strong>：任務管理、佇列、信號量、軟體定時器</li>
                <li><strong>Zephyr</strong>：完整 RTOS 功能 + Device Tree + West</li>
            </ul>

            <h3>網路元件</h3>
            <ul>
                <li><strong>lwIP</strong>：TCP/IP 協定棧，支援 IPv4/IPv6</li>
                <li><strong>Mbed TLS</strong>：TLS/SSL、加密演算法</li>
            </ul>

            <h3>儲存元件</h3>
            <ul>
                <li><strong>LittleFS</strong>：針對 Flash 優化的檔案系統</li>
                <li><strong>FatFS</strong>：FAT 檔案系統，用於 SD 卡</li>
            </ul>
        </section>
    </article>
</div>
---
layout: default
title: BLE 開發指南
---

<div class="doc-layout">
    <aside class="doc-sidebar">
        <nav class="sidebar-nav">
            <h4 class="sidebar-title">本頁目錄</h4>
            <ul class="sidebar-links">
                <li><a href="#stack-architecture" class="sidebar-link">協定棧架構</a></li>
                <li><a href="#controller-variants" class="sidebar-link">控制器變體</a></li>
                <li><a href="#api-patterns" class="sidebar-link">API 模式</a></li>
                <li><a href="#le-audio" class="sidebar-link">LE Audio</a></li>
                <li><a href="#app-framework" class="sidebar-link">應用框架</a></li>
                <li><a href="#reference-apps" class="sidebar-link">參考應用</a></li>
                <li><a href="#prebuilt-libs" class="sidebar-link">預建構函式庫</a></li>
            </ul>
        </nav>
    </aside>

    <article class="doc-content">
        <h1>BLE 開發指南</h1>
        <p>本指南介紹如何使用 IPRO SDK 的 BLE 協定棧開發藍牙低功耗應用。SDK 採用 Zephyr BLE Host Stack 搭配 RivieraWaves 預建構控制器，提供完整的 BLE 5.4 功能支援。</p>

        <!-- ============================================================ -->
        <!-- Stack Architecture -->
        <!-- ============================================================ -->
        <section id="stack-architecture">
            <h2>協定棧架構</h2>
            <p>BLE 協定棧採用 Host + Controller 雙層架構，透過片上 HCI 介面通訊（無 UART HCI 傳輸）：</p>

            <div class="protocol-stack">
                <div class="stack-layer stack-green">
                    <div class="layer-name">Application Layer</div>
                    <div class="layer-detail">GAP / GATT Services / Profiles</div>
                </div>
                <div class="stack-layer stack-cyan">
                    <div class="layer-name">BLE Host (Zephyr-based)</div>
                    <div class="layer-detail">GAP / GATT / L2CAP / SMP / ISO</div>
                </div>
                <div class="stack-layer stack-amber">
                    <div class="layer-name">HCI (On-Chip)</div>
                    <div class="layer-detail">ipro_hci_wrapper</div>
                </div>
                <div class="stack-layer stack-red">
                    <div class="layer-name">BLE Controller (RivieraWaves)</div>
                    <div class="layer-detail">Link Layer / PHY (1M/2M/Coded)</div>
                </div>
            </div>

            <h3>核心概念</h3>
            <ul>
                <li><strong>Zephyr BLE Host</strong>：即使在 FreeRTOS 上也使用 Zephyr BLE Host Stack，應用程式透過標準 <code>bt_*</code> API 操作</li>
                <li><strong>RivieraWaves 控制器</strong>：以預建構靜態庫形式提供，負責 Link Layer 與 PHY 管理</li>
                <li><strong>片上 HCI</strong>：Host 與 Controller 之間使用片上 HCI 通訊，無需 UART HCI 傳輸層</li>
                <li><strong>回調驅動</strong>：所有非同步事件（連線、斷線、通知）透過回調函式處理</li>
            </ul>

            <h3>原始碼結構</h3>
            <div class="code-block">
                <div class="code-block-header">
                    <span class="code-block-title">BLE 元件目錄</span>
                </div>
                <pre><code>components/wireless/bluetooth/
├── blestack/                        # Zephyr BLE Host Stack（可建構原始碼）
│   └── src/include/bluetooth/       # 公開標頭檔
│       ├── bluetooth.h              # bt_enable(), bt_le_adv_start()
│       ├── conn.h                   # bt_conn_create_le(), bt_conn_cb_register()
│       ├── gatt.h                   # bt_gatt_service_register(), bt_gatt_notify()
│       ├── uuid.h                   # BT_UUID_DECLARE_16() 等
│       └── audio/                   # LE Audio API（BAP, CAP, VCP...）
├── btblecontroller/                 # RivieraWaves 控制器原始碼（需授權）
├── btblecontroller_ipro7_&lt;variant&gt;/ # 預建構控制器靜態庫
├── btprofile/                       # 20+ GATT Profiles 實作
│   ├── bas/   dis/   hogp/          # 電池、裝置資訊、HID
│   ├── csip/  otp/   find/          # CSIP、OTP、Find Me
│   └── ...
├── blemesh/                         # Bluetooth Mesh 支援
├── ble_common.cmake                 # 控制器變體配置
└── build_all_prebuilts.sh           # 預建構庫建置腳本</code></pre>
            </div>
        </section>

        <!-- ============================================================ -->
        <!-- Controller Variants -->
        <!-- ============================================================ -->
        <section id="controller-variants">
            <h2>控制器變體</h2>
            <p>控制器採用統一連線池架構，<code>linkN</code> 中的 N 表示同時連線數。每個連線槽可作為 Central 或 Peripheral 使用（任意角色組合）。</p>

            <h3>基礎變體</h3>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>變體</th>
                            <th>最大連線數</th>
                            <th>BLE 版本</th>
                            <th>LE Audio</th>
                            <th>適用場景</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>link1_periph</code></td>
                            <td>1</td>
                            <td>5.0+</td>
                            <td>否</td>
                            <td>簡易周邊設備（最小 footprint）</td>
                        </tr>
                        <tr>
                            <td><code>link1</code></td>
                            <td>1</td>
                            <td>5.0+</td>
                            <td>否</td>
                            <td>單連線，支援所有角色</td>
                        </tr>
                        <tr>
                            <td><code>link2</code></td>
                            <td>2</td>
                            <td>5.0+</td>
                            <td>否</td>
                            <td>雙連線（2C+0P, 1C+1P, 0C+2P）</td>
                        </tr>
                        <tr>
                            <td><code>link4</code></td>
                            <td>4</td>
                            <td>5.0+</td>
                            <td>否</td>
                            <td>多連線應用</td>
                        </tr>
                        <tr>
                            <td><code>link8</code></td>
                            <td>8</td>
                            <td>5.0+</td>
                            <td>否</td>
                            <td>Hub / 閘道器</td>
                        </tr>
                        <tr>
                            <td><code>link1_leaudio</code></td>
                            <td>1</td>
                            <td>5.2</td>
                            <td>是</td>
                            <td>LE Audio 周邊設備</td>
                        </tr>
                        <tr>
                            <td><code>link2_leaudio</code></td>
                            <td>2</td>
                            <td>5.2</td>
                            <td>是</td>
                            <td>LE Audio 雙連線</td>
                        </tr>
                        <tr>
                            <td><code>link1_leaudio_53_54</code></td>
                            <td>1</td>
                            <td>5.4</td>
                            <td>是</td>
                            <td>最新 BLE + LE Audio</td>
                        </tr>
                        <tr>
                            <td><code>link2_leaudio_53_54</code></td>
                            <td>2</td>
                            <td>5.4</td>
                            <td>是</td>
                            <td>最新 BLE + LE Audio</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <h3>Kconfig 配置</h3>
            <p>在應用程式的 <code>.config</code> 中透過 <code>CONFIG_BTBLECONTROLLER_LIB</code> 選擇變體：</p>
            <div class="code-block">
                <div class="code-block-header">
                    <span class="code-block-title">.config 變體選擇</span>
                    <button class="code-copy-btn"><i class="fas fa-copy"></i></button>
                </div>
                <pre><code class="language-bash"># 直接指定變體名稱
CONFIG_BTBLECONTROLLER_LIB="link2"

# 或使用布林旗標組合（自動拼接後綴）
CONFIG_BTBLECONTROLLER_LIB="link2"
CONFIG_BTBLECONTROLLER_LE_AUDIO=y     # 加上 _leaudio
CONFIG_BTBLECONTROLLER_BT_54=y        # 加上 _53_54（5.4 隱含 5.3）
# 結果變體：link2_leaudio_53_54</code></pre>
            </div>

            <p>預建構庫位於：<code>components/wireless/bluetooth/btblecontroller_ipro7_&lt;variant&gt;/</code></p>
        </section>

        <!-- ============================================================ -->
        <!-- API Patterns -->
        <!-- ============================================================ -->
        <section id="api-patterns">
            <h2>API 模式</h2>
            <p>應用程式使用 Zephyr 風格的回調驅動 BLE API。舊版 RivieraWaves <code>ke_msg</code> 訊息傳遞機制僅限控制器內部使用，不對應用程式暴露。</p>

            <h3>GAP：廣播與掃描</h3>
            <div class="code-block">
                <div class="code-block-header">
                    <span class="code-block-title">GAP 廣播操作</span>
                    <button class="code-copy-btn"><i class="fas fa-copy"></i></button>
                </div>
                <pre><code class="language-c">#include &lt;bluetooth/bluetooth.h&gt;
#include &lt;bluetooth/conn.h&gt;

/* 廣播資料 */
static const struct bt_data ad[] = {
    BT_DATA_BYTES(BT_DATA_FLAGS,
                  BT_LE_AD_GENERAL | BT_LE_AD_NO_BREDR),
    BT_DATA_BYTES(BT_DATA_UUID16_ALL,
                  0x0d, 0x18),  /* Heart Rate Service */
};

static const struct bt_data sd[] = {
    BT_DATA(BT_DATA_NAME_COMPLETE, "IPRO Device", 11),
};

/* 開始可連線廣播 */
bt_le_adv_start(BT_LE_ADV_CONN_NAME,
                ad, ARRAY_SIZE(ad), sd, ARRAY_SIZE(sd));

/* 停止廣播 */
bt_le_adv_stop();

/* 開始掃描（Central 角色） */
bt_le_scan_start(BT_LE_SCAN_ACTIVE, scan_cb);</code></pre>
            </div>

            <h3>連線回調</h3>
            <div class="code-block">
                <div class="code-block-header">
                    <span class="code-block-title">連線管理</span>
                    <button class="code-copy-btn"><i class="fas fa-copy"></i></button>
                </div>
                <pre><code class="language-c">static void connected(struct bt_conn *conn, u8_t err)
{
    if (err) {
        printk("Connection failed (err %u)\n", err);
        return;
    }
    printk("Connected\n");
}

static void disconnected(struct bt_conn *conn, u8_t reason)
{
    printk("Disconnected (reason %u)\n", reason);
}

static struct bt_conn_cb conn_callbacks = {
    .connected = connected,
    .disconnected = disconnected,
};

void app_init(void)
{
    bt_conn_cb_register(&amp;conn_callbacks);
    bt_enable(bt_ready);
}</code></pre>
            </div>

            <h3>GATT：服務註冊</h3>
            <div class="code-block">
                <div class="code-block-header">
                    <span class="code-block-title">靜態 GATT 服務定義</span>
                    <button class="code-copy-btn"><i class="fas fa-copy"></i></button>
                </div>
                <pre><code class="language-c">#include &lt;bluetooth/gatt.h&gt;
#include &lt;bluetooth/uuid.h&gt;

/* 自訂 UUID */
static struct bt_uuid_128 my_svc_uuid = BT_UUID_INIT_128(
    0xf0, 0xde, 0xbc, 0x9a, 0x78, 0x56, 0x34, 0x12,
    0x78, 0x56, 0x34, 0x12, 0x78, 0x56, 0x34, 0x12);

static struct bt_uuid_128 my_char_uuid = BT_UUID_INIT_128(
    0xf1, 0xde, 0xbc, 0x9a, 0x78, 0x56, 0x34, 0x12,
    0x78, 0x56, 0x34, 0x12, 0x78, 0x56, 0x34, 0x12);

static uint8_t my_value[256];

/* 讀取回調 */
static ssize_t read_my_char(struct bt_conn *conn,
                            const struct bt_gatt_attr *attr,
                            void *buf, u16_t len, u16_t offset)
{
    return bt_gatt_attr_read(conn, attr, buf, len, offset,
                             my_value, sizeof(my_value));
}

/* 使用巨集定義服務（編譯期靜態註冊） */
BT_GATT_SERVICE_DEFINE(my_svc,
    BT_GATT_PRIMARY_SERVICE(&amp;my_svc_uuid),
    BT_GATT_CHARACTERISTIC(&amp;my_char_uuid.uuid,
                           BT_GATT_CHRC_READ | BT_GATT_CHRC_NOTIFY,
                           BT_GATT_PERM_READ,
                           read_my_char, NULL, my_value),
    BT_GATT_CCC(NULL, BT_GATT_PERM_READ | BT_GATT_PERM_WRITE),
);

/* 發送 GATT 通知 */
bt_gatt_notify(conn, &amp;my_svc.attrs[1], my_value, sizeof(my_value));</code></pre>
            </div>

            <div class="alert alert-info">
                <strong>提示：</strong>舊版 <code>ipro_ble_api.h</code> 與 RivieraWaves <code>ke_msg</code> API 已棄用。所有新應用程式應使用 Zephyr <code>bt_*</code> API。
            </div>
        </section>

        <!-- ============================================================ -->
        <!-- LE Audio -->
        <!-- ============================================================ -->
        <section id="le-audio">
            <h2>LE Audio 生態系統</h2>
            <p>SDK 支援完整的 LE Audio 功能，需使用 <code>_leaudio</code> 後綴的控制器變體。標頭檔位於 <code>bluetooth/audio/</code>。</p>

            <h3>LE Audio Profiles</h3>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Profile</th>
                            <th>全名</th>
                            <th>功能</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>BAP</strong></td>
                            <td>Basic Audio Profile</td>
                            <td>音訊串流管理（單播/廣播）</td>
                        </tr>
                        <tr>
                            <td><strong>CAP</strong></td>
                            <td>Common Audio Profile</td>
                            <td>協調設備集合的音訊操作</td>
                        </tr>
                        <tr>
                            <td><strong>VCP</strong></td>
                            <td>Volume Control Profile</td>
                            <td>音量控制</td>
                        </tr>
                        <tr>
                            <td><strong>MCP</strong></td>
                            <td>Media Control Profile</td>
                            <td>媒體播放控制</td>
                        </tr>
                        <tr>
                            <td><strong>CSIP</strong></td>
                            <td>Coordinated Set Identification Profile</td>
                            <td>協調設備識別（如左右耳機配對）</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <h3>LC3 編解碼管線</h3>
            <p>LE Audio 使用 LC3 (Low Complexity Communication Codec) 作為強制編解碼器，支援 32-320 kbps 位元率，音訊延遲低於 20ms。音訊資料透過 Isochronous Channels (CIS/BIS) 傳輸。</p>

            <h3>配置範例</h3>
            <div class="code-block">
                <div class="code-block-header">
                    <span class="code-block-title">.config LE Audio 配置</span>
                    <button class="code-copy-btn"><i class="fas fa-copy"></i></button>
                </div>
                <pre><code class="language-bash"># 啟用 LE Audio 控制器
CONFIG_BTBLECONTROLLER_LIB="link2"
CONFIG_BTBLECONTROLLER_LE_AUDIO=y
CONFIG_BTBLECONTROLLER_BT_54=y
# 結果變體：link2_leaudio_53_54

# 啟用 LE Audio Host 功能
CONFIG_BT_AUDIO=y
CONFIG_BT_BAP_UNICAST_SERVER=y
CONFIG_BT_ASCS=y
CONFIG_BT_PACS=y
CONFIG_BT_VCP_VOL_REND=y
CONFIG_BT_CSIP_SET_MEMBER=y</code></pre>
            </div>

            <div class="alert alert-info">
                <strong>交叉參考：</strong>詳細的音訊管線說明請參閱「音訊與多媒體」頁面。
            </div>
        </section>

        <!-- ============================================================ -->
        <!-- App Framework -->
        <!-- ============================================================ -->
        <section id="app-framework">
            <h2>應用框架</h2>
            <p>BLE 應用採用 Mediator 設計模式，將複雜的藍牙功能分解為可重用的元件：</p>

            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>元件</th>
                            <th>角色</th>
                            <th>說明</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Mediator</strong></td>
                            <td>協調者</td>
                            <td>管理 Applet 之間的互動與生命週期，負責整體流程控制</td>
                        </tr>
                        <tr>
                            <td><strong>Applets</strong></td>
                            <td>可重用元件</td>
                            <td>封裝特定功能（如廣播管理、GATT 服務、音訊串流），可在不同應用間共用</td>
                        </tr>
                        <tr>
                            <td><strong>Intermediaries</strong></td>
                            <td>協議橋接</td>
                            <td>在不同協議層之間轉換資料格式，例如將應用層命令轉為 BLE GAP/GATT 操作</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <p>此框架主要用於 LE Audio 應用（如 GAF、BAP、VCP、MCP、CAP），將複雜的音訊管理邏輯模組化。</p>
        </section>

        <!-- ============================================================ -->
        <!-- Reference Applications -->
        <!-- ============================================================ -->
        <section id="reference-apps">
            <h2>參考應用</h2>
            <p>SDK 提供多個 BLE 參考應用程式，涵蓋常見的藍牙使用場景：</p>

            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>應用</th>
                            <th>功能說明</th>
                            <th>控制器變體</th>
                            <th>路徑</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>ipro_ble_remote</strong></td>
                            <td>GATT 服務 + OTA 更新，6 個服務，圖片傳輸達 101 KB/s</td>
                            <td>link2</td>
                            <td><code>apps/bluetooth/ipro_ble_remote/</code></td>
                        </tr>
                        <tr>
                            <td><strong>ipro_throughput_test</strong></td>
                            <td>吞吐量基準測試，最高 999 Kbps，原生 Zephyr bt_* API，支援 Master/Slave 角色</td>
                            <td>link2</td>
                            <td><code>apps/bluetooth/ipro_throughput_test/</code></td>
                        </tr>
                        <tr>
                            <td><strong>ipro_ble_transparent</strong></td>
                            <td>UART 透傳橋接，BLE 與序列埠雙向透傳</td>
                            <td>link1</td>
                            <td><code>apps/bluetooth/ipro_ble_transparent/</code></td>
                        </tr>
                        <tr>
                            <td><strong>ipro_ble_hid_keyboard</strong></td>
                            <td>HOGP HID 鍵盤，使用 HID over GATT Profile</td>
                            <td>link1_periph</td>
                            <td><code>apps/bluetooth/ipro_ble_hid_keyboard/</code></td>
                        </tr>
                        <tr>
                            <td><strong>ipro_le_audio_headset</strong></td>
                            <td>GAF/BAP 單播音訊耳機，支援 VCP、CSIP</td>
                            <td>link2_leaudio_53_54</td>
                            <td><code>apps/bluetooth/ipro_le_audio_headset/</code></td>
                        </tr>
                        <tr>
                            <td><strong>ipro_walkie_talkie</strong></td>
                            <td>BIS LE Audio 廣播對講機</td>
                            <td>link2_leaudio</td>
                            <td><code>apps/bluetooth/ipro_walkie_talkie/</code></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- ============================================================ -->
        <!-- Prebuilt Library Workflow -->
        <!-- ============================================================ -->
        <section id="prebuilt-libs">
            <h2>預建構函式庫</h2>
            <p>BLE 控制器以預建構靜態庫形式提供。正式發行版不可使用 <code>CONFIG_BLE_FORCE_SOURCE_BUILD</code>。</p>

            <h3>建構腳本</h3>
            <div class="code-block">
                <div class="code-block-header">
                    <span class="code-block-title">建構預建構庫</span>
                    <button class="code-copy-btn"><i class="fas fa-copy"></i></button>
                </div>
                <pre><code class="language-bash"># 建構特定變體
components/wireless/bluetooth/build_all_prebuilts.sh link2

# 建構所有變體
components/wireless/bluetooth/build_all_prebuilts.sh all

# 輸出位置
# btblecontroller_ipro7_link2/libbtblecontroller_ipro7_link2.a</code></pre>
            </div>

            <h3>開發時原始碼建構</h3>
            <div class="code-block">
                <div class="code-block-header">
                    <span class="code-block-title">.config 啟用原始碼建構（僅開發用）</span>
                    <button class="code-copy-btn"><i class="fas fa-copy"></i></button>
                </div>
                <pre><code class="language-bash"># 僅限開發除錯，不可用於正式發行
CONFIG_BLE_FORCE_SOURCE_BUILD=y</code></pre>
            </div>

            <div class="alert alert-warning">
                <strong>注意：</strong><code>CONFIG_BLE_FORCE_SOURCE_BUILD</code> 僅供開發除錯使用，不可用於正式發行版本。正式版必須使用預建構靜態庫。
            </div>

            <h3>庫檔案位置</h3>
            <p>預建構庫存放於 <code>components/wireless/bluetooth/</code> 下，命名格式為：</p>
            <div class="code-block">
                <div class="code-block-header">
                    <span class="code-block-title">預建構庫目錄</span>
                </div>
                <pre><code>btblecontroller_ipro7_link1/
btblecontroller_ipro7_link1_periph/
btblecontroller_ipro7_link2/
btblecontroller_ipro7_link4/
btblecontroller_ipro7_link8/
btblecontroller_ipro7_link1_leaudio/
btblecontroller_ipro7_link2_leaudio/
btblecontroller_ipro7_link1_leaudio_53_54/
btblecontroller_ipro7_link2_leaudio_53_54/
...</code></pre>
            </div>
        </section>
    </article>
</div>

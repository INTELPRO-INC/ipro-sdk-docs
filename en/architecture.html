---
layout: default
title: Architecture Overview - IPRO SDK
lang: en
---

<div class="doc-layout">
    <aside class="doc-sidebar">
        <nav class="sidebar-nav">
            <h4 class="sidebar-title">Table of Contents</h4>
            <ul class="sidebar-links">
                <li><a href="#overview" class="sidebar-link">Architecture Overview</a></li>
                <li><a href="#layers" class="sidebar-link">Layered Design</a></li>
                <li><a href="#memory-layout" class="sidebar-link">Memory Layout</a></li>
                <li><a href="#directory" class="sidebar-link">Directory Structure</a></li>
                <li><a href="#build-system" class="sidebar-link">Build System</a></li>
                <li><a href="#configuration" class="sidebar-link">Configuration</a></li>
                <li><a href="#ble-controller" class="sidebar-link">BLE Controller</a></li>
                <li><a href="#components" class="sidebar-link">Components</a></li>
            </ul>
        </nav>
    </aside>

    <article class="doc-content">
        <h1>Architecture Overview</h1>
        <p>IPRO SDK adopts a clear layered architecture design, providing high modularity and portability, enabling developers to quickly build stable embedded applications.</p>

        <section id="overview">
            <h2>System Architecture Diagram</h2>
            <p>The overall SDK architecture consists of five main layers:</p>

            <div class="code-block">
                <div class="code-block-header">
                    <span class="code-block-title">IPRO SDK Architecture</span>
                </div>
                <pre><code>+------------------------------------------------------+
|                 Application Layer                    |
|              (e.g., apps/ipro7_demo)                 |
+------------------------------------------------------+
|          Middleware & Reusable Components            |
|   (lwIP, Mbed TLS, CherryUSB, File Systems, etc.)    |
+------------------------------------------------------+
|       Real-Time OS (FreeRTOS or Zephyr RTOS)        |
+------------------------------------------------------+
|             Board Support Package (BSP)              |
|   +----------------------------------------------+   |
|   | Hardware Abstraction Layer (HAL) & Drivers   |   |
|   +----------------------------------------------+   |
+------------------------------------------------------+
|               IPRO Hardware Platform                 |
+------------------------------------------------------+</code></pre>
            </div>
        </section>

        <section id="layers">
            <h2>Layer Details</h2>

            <h3>Application Layer</h3>
            <p>Located in <code>apps/</code> directory, contains all application projects. Each application is an independent project with its own:</p>
            <ul>
                <li><code>CMakeLists.txt</code> - Build configuration</li>
                <li><code>proj.conf</code> - Kconfig configuration overrides</li>
                <li><code>main.c</code> - Application entry point</li>
                <li><code>Kconfig.app</code> - Application-specific options</li>
            </ul>

            <h3>Middleware Layer</h3>
            <p>Located in <code>components/</code> directory, provides reusable software components:</p>

            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Component</th>
                            <th>Directory</th>
                            <th>Function</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>lwIP</td>
                            <td><code>components/network/</code></td>
                            <td>Lightweight TCP/IP Stack</td>
                        </tr>
                        <tr>
                            <td>Mbed TLS</td>
                            <td><code>components/crypto/</code></td>
                            <td>Encryption & Secure Communication</td>
                        </tr>
                        <tr>
                            <td>CherryUSB</td>
                            <td><code>components/cherryusb/</code></td>
                            <td>USB Device/Host Stack</td>
                        </tr>
                        <tr>
                            <td>Wireless</td>
                            <td><code>components/wireless/</code></td>
                            <td>BLE 5.4, Zigbee, Thread</td>
                        </tr>
                        <tr>
                            <td>File Systems</td>
                            <td><code>components/fs/</code></td>
                            <td>FAT, LittleFS, etc.</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <h3>RTOS Layer</h3>
            <p>SDK supports two real-time operating systems:</p>
            <ul>
                <li><strong>FreeRTOS</strong> - Located in <code>components/os/freertos/</code>, classic and stable RTOS choice</li>
                <li><strong>Zephyr RTOS</strong> - Modern RTOS with Device Tree, West build system, and advanced features</li>
            </ul>

            <h3>BSP Layer (Board Support Package)</h3>
            <p>Located in <code>bsp/</code> directory, provides hardware abstraction:</p>
            <ul>
                <li><code>bsp/hal/</code> - Hardware Abstraction Layer API</li>
                <li><code>bsp/drivers/</code> - Peripheral drivers</li>
                <li><code>bsp/board/</code> - Board-level configuration</li>
            </ul>

            <h4>Supported Peripheral Drivers</h4>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th>Drivers</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Communication</td>
                            <td>UART, SPI (Master/Slave), I2C, I2S</td>
                        </tr>
                        <tr>
                            <td>Storage</td>
                            <td>SD Card (SDH), SPI Flash, PSRAM</td>
                        </tr>
                        <tr>
                            <td>Display</td>
                            <td>LCD (ILI9488 SPI), OSD blend/draw</td>
                        </tr>
                        <tr>
                            <td>Audio</td>
                            <td>AUADC, DAC, I2S</td>
                        </tr>
                        <tr>
                            <td>Multimedia</td>
                            <td>ISP Camera, DVP sensor, MJPEG codec</td>
                        </tr>
                        <tr>
                            <td>Network</td>
                            <td>EMAC Ethernet</td>
                        </tr>
                        <tr>
                            <td>USB</td>
                            <td>Device (CDC, MSC, HID, UAC, UVC)</td>
                        </tr>
                        <tr>
                            <td>Others</td>
                            <td>GPIO, PWM, ADC, Timer, IR, QDEC, DMA</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <section id="memory-layout">
            <h2>Memory Layout (IPRO7)</h2>
            <p>IPRO7 uses RISC-V <code>rv32imafc</code> / <code>ilp32f</code> architecture, running at 192MHz. Memory layout is as follows:</p>

            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Region</th>
                            <th>Size</th>
                            <th>Start Address</th>
                            <th>Purpose</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Flash</td>
                            <td>4 MB</td>
                            <td><code>0x00000000</code></td>
                            <td>Code and read-only data storage</td>
                        </tr>
                        <tr>
                            <td>PSRAM</td>
                            <td>16 MB</td>
                            <td><code>0x20000000</code></td>
                            <td>Main RAM (heap, data segments)</td>
                        </tr>
                        <tr>
                            <td>OCRAM</td>
                            <td>256 KB</td>
                            <td><code>0x60000000</code></td>
                            <td>High-speed SRAM (stack, critical code)</td>
                        </tr>
                        <tr>
                            <td>HBNRAM</td>
                            <td>4 KB</td>
                            <td><code>0x50000000</code></td>
                            <td>Hibernate retention RAM</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <section id="directory">
            <h2>Directory Structure</h2>

            <div class="code-block">
                <div class="code-block-header">
                    <span class="code-block-title">SDK Directory Structure</span>
                </div>
                <pre><code>ipro_sdk/
‚îú‚îÄ‚îÄ apps/                         # Application projects
‚îÇ   ‚îú‚îÄ‚îÄ bluetooth/                # BLE applications
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ipro_ble_remote/      # BLE remote (GATT + OTA)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ipro_throughput_test/ # BLE throughput test (999 Kbps)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ipro_walkie_talkie/   # BIS LE Audio walkie-talkie
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ipro_le_audio_headset/# GAF/BAP LE Audio headset
‚îÇ   ‚îú‚îÄ‚îÄ ipro7_demo/               # Comprehensive platform demo
‚îÇ   ‚îú‚îÄ‚îÄ ipro_unit_test/           # Unit tests
‚îÇ   ‚îî‚îÄ‚îÄ ipro_zephyr_demo/         # Zephyr demo
‚îÇ
‚îú‚îÄ‚îÄ bsp/                          # Board Support Package
‚îÇ   ‚îú‚îÄ‚îÄ board/                    # Board configuration
‚îÇ   ‚îú‚îÄ‚îÄ drivers/                  # Peripheral drivers
‚îÇ   ‚îú‚îÄ‚îÄ hal/                      # Hardware Abstraction Layer
‚îÇ   ‚îî‚îÄ‚îÄ common/                   # Common code
‚îÇ
‚îú‚îÄ‚îÄ components/                   # Reusable components (23 categories)
‚îÇ   ‚îú‚îÄ‚îÄ wireless/                 # Wireless stack
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ bluetooth/            # BLE 5.4 stack
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ blestack/         # Zephyr BLE Host (GAP/GATT/L2CAP/SMP)
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ btblecontroller/  # Prebuilt controller libraries (linkN variants)
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ btprofile/        # 70+ BLE Profiles
‚îÇ   ‚îú‚îÄ‚îÄ os/                       # RTOS components (FreeRTOS)
‚îÇ   ‚îú‚îÄ‚îÄ network/                  # Network stack (lwIP)
‚îÇ   ‚îú‚îÄ‚îÄ crypto/                   # Crypto components (Mbed TLS)
‚îÇ   ‚îú‚îÄ‚îÄ fs/                       # File systems (LittleFS, FatFS)
‚îÇ   ‚îú‚îÄ‚îÄ cherryusb/                # USB device/host stack
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ
‚îú‚îÄ‚îÄ tools/                        # Development tools
‚îÇ   ‚îú‚îÄ‚îÄ ipro_iot_tool_lite/       # Flash tool
‚îÇ   ‚îú‚îÄ‚îÄ serial_monitor.py         # Serial monitor (Python3)
‚îÇ   ‚îú‚îÄ‚îÄ board_test.sh             # Automated board testing
‚îÇ   ‚îú‚îÄ‚îÄ zephyr/                   # Zephyr tool scripts
‚îÇ   ‚îú‚îÄ‚îÄ vscode_extension/         # VS Code extension
‚îÇ   ‚îî‚îÄ‚îÄ cmake/                    # CI CMake
‚îÇ
‚îú‚îÄ‚îÄ cmake/                        # CMake config (toolchain.cmake auto-detection)
‚îú‚îÄ‚îÄ kconfigs/                     # Kconfig files
‚îÇ
‚îú‚îÄ‚îÄ build_freertos.sh             # FreeRTOS build script
‚îú‚îÄ‚îÄ CMakeLists.txt                # Root CMake config
‚îú‚îÄ‚îÄ Kconfig                       # Root Kconfig
‚îî‚îÄ‚îÄ west.yml                      # Zephyr west config</code></pre>
            </div>
        </section>

        <section id="build-system">
            <h2>Build System</h2>

            <h3>CMake + Ninja</h3>
            <p>SDK uses CMake as the build system, with Ninja as the build backend for optimal performance.</p>

            <h4>Build Process</h4>
            <ol>
                <li><strong>Configuration Phase</strong>: CMake reads <code>CMakeLists.txt</code> and Kconfig, generates build rules</li>
                <li><strong>Build Phase</strong>: Ninja executes compilation and linking, produces final binaries</li>
            </ol>

            <div class="code-block">
                <div class="code-block-header">
                    <span class="code-block-title">Build Command Parameters</span>
                    <button class="code-copy-btn"><i class="fas fa-copy"></i></button>
                </div>
                <pre><code class="language-bash">cmake -S . -B build \
    -G "Ninja" \                      # Use Ninja builder
    -DIPRO_SDK_BASE=$(pwd) \          # SDK root directory
    -DCONFIG_BUILD_PORJECT=app_name \ # Target app name
    -DCMAKE_PREFIX_PATH=$(pwd)/cmake \# CMake module path
    -DCUSTOM_CONFIG_DIR=path/to/app \ # App config directory
    -DCONFIG_APPS=1 \                 # Enable app build
    -DCROSS_COMPILE=path/to/toolchain # Cross compiler prefix</code></pre>
            </div>

            <h3>West Build System (Zephyr)</h3>
            <p>Zephyr projects use <code>west</code> as the build tool, providing a more modern development experience.</p>

            <div class="code-block">
                <div class="code-block-header">
                    <span class="code-block-title">West Build Commands</span>
                    <button class="code-copy-btn"><i class="fas fa-copy"></i></button>
                </div>
                <pre><code class="language-bash"># Initialize west workspace
west init -m https://github.com/your-org/ipro_sdk --mr main
west update

# Build application
west build -b ipro7_fpga apps/ipro_zephyr_demo

# Flash
west flash</code></pre>
            </div>
        </section>

        <section id="configuration">
            <h2>Configuration System (Kconfig)</h2>
            <p>SDK uses Kconfig system for project configuration, providing both graphical and text-based configuration interfaces.</p>

            <h3>Configuration Hierarchy</h3>
            <p>The SDK uses Linux kernel-style Kconfig. Each app has its own <code>.config</code> file with <code>CONFIG_*</code> variables. The build generates <code>generated/autoconf.h</code> from <code>.config</code>.</p>
            <ol>
                <li><strong>Root Config</strong>: <code>Kconfig</code> - Defines all available options</li>
                <li><strong>Default Config</strong>: <code>kconfigs/*.config</code> - Default values for each module</li>
                <li><strong>App Config</strong>: <code>apps/*/.config</code> - Application-specific configuration</li>
            </ol>

            <h3>Key Configuration Options</h3>
            <div class="code-block">
                <div class="code-block-header">
                    <span class="code-block-title">.config Example</span>
                    <button class="code-copy-btn"><i class="fas fa-copy"></i></button>
                </div>
                <pre><code class="language-bash"># SoC selection
CONFIG_IPRO7=y
CONFIG_CPU_ID="intelpro_ipro7"

# RTOS selection
CONFIG_FREERTOS_SUPPORT=y

# Wireless features
CONFIG_BLUETOOTH_LE_ENABLE=y

# Component enables
CONFIG_LWIP=y
CONFIG_MBEDTLS=y

# Test auto-run
CONFIG_TEST_AUTO_RUN=y</code></pre>
            </div>

            <div class="alert alert-info">
                <strong>üí° Tip:</strong> <code>CONFIG_CPU_ID</code> must be set in <code>.config</code> for the toolchain to correctly detect architecture flags. <code>cmake/toolchain.cmake</code> auto-detects vendor GCC (with <code>_xxldsp</code> extensions) vs standard GCC and adapts compiler flags.
            </div>
        </section>

        <section id="ble-controller">
            <h2>BLE Controller & Prebuilt Libraries</h2>

            <h3>BLE Stack Architecture</h3>
            <p>The BLE 5.4 stack is located in <code>components/wireless/bluetooth/</code>, using Zephyr-style callback-based GAP/GATT APIs:</p>
            <ul>
                <li><code>blestack/</code> - Zephyr BLE Host (GAP, GATT, L2CAP, SMP, ISO, LE Audio) - buildable source</li>
                <li><code>btblecontroller/</code> - RivieraWaves Controller (prebuilt linkN variant libraries)</li>
                <li><code>btprofile/</code> - 70+ BLE Profiles</li>
                <li><code>blemesh/</code> - Bluetooth Mesh support (optional)</li>
            </ul>

            <h3>Controller Variants (linkN naming)</h3>
            <p>The controller uses a unified connection pool design with <code>linkN</code> naming (replaces old <code>mXsY</code> naming):</p>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Variant</th>
                            <th>BLE Version</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>link1_periph</code>, <code>link1</code>, <code>link2</code>, <code>link4</code>, <code>link8</code></td>
                            <td>BLE 5.0+</td>
                            <td>Base BLE, different connection counts</td>
                        </tr>
                        <tr>
                            <td><code>link1_leaudio</code>, <code>link2_leaudio</code></td>
                            <td>BLE 5.2</td>
                            <td>With LE Audio support</td>
                        </tr>
                        <tr>
                            <td><code>link1_leaudio_53_54</code>, <code>link2_leaudio_53_54</code></td>
                            <td>BLE 5.4</td>
                            <td>With LE Audio + BLE 5.3/5.4 features</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <h3>Prebuilt Library System</h3>
            <div class="code-block">
                <div class="code-block-header">
                    <span class="code-block-title">Build Prebuilt Controller Libraries</span>
                    <button class="code-copy-btn"><i class="fas fa-copy"></i></button>
                </div>
                <pre><code class="language-bash"># Build specific variant
components/wireless/bluetooth/build_all_prebuilts.sh link2

# Build all variants
components/wireless/bluetooth/build_all_prebuilts.sh all

# Output: btblecontroller_ipro7_&lt;variant&gt;/libbtblecontroller_ipro7_&lt;variant&gt;.a</code></pre>
            </div>

            <div class="alert alert-warning">
                <strong>‚ö†Ô∏è Note:</strong> <code>CONFIG_BLE_FORCE_SOURCE_BUILD</code> cannot be used in release builds. Release builds must use prebuilt libraries.
            </div>
        </section>

        <section id="components">
            <h2>Main Components Overview</h2>

            <h3>BLE Stack (Zephyr-based, BLE 5.4)</h3>
            <p>Complete BLE 5.4 implementation. Applications use Zephyr-style callback-based GAP/GATT APIs:</p>
            <ul>
                <li><strong>Host Layer</strong>: GAP/GATT management, connection control, security management (SMP), L2CAP</li>
                <li><strong>Profile Layer</strong>: 70+ standard BLE Profiles</li>
                <li><strong>Audio Layer</strong>: LE Audio (GAF, BAP, VCP, MCP, CAP), LC3 codec</li>
                <li><strong>App Framework</strong>: Mediator (orchestrator) - Applets (reusable components) - Intermediaries (protocol bridges)</li>
            </ul>

            <h3>RTOS Components</h3>
            <ul>
                <li><strong>FreeRTOS</strong>: Task management, queues, semaphores, software timers</li>
                <li><strong>Zephyr</strong>: Full RTOS features + Device Tree + West</li>
            </ul>

            <h3>Network Components</h3>
            <ul>
                <li><strong>lwIP</strong>: TCP/IP stack, supports IPv4/IPv6</li>
                <li><strong>Mbed TLS</strong>: TLS/SSL, cryptographic algorithms</li>
            </ul>

            <h3>Storage Components</h3>
            <ul>
                <li><strong>LittleFS</strong>: Flash-optimized file system</li>
                <li><strong>FatFS</strong>: FAT file system for SD cards</li>
            </ul>
        </section>
    </article>
</div>

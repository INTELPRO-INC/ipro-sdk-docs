---
layout: default
title: BLE Development Guide
lang: en
---

<div class="doc-layout">
    <aside class="doc-sidebar">
        <nav class="sidebar-nav">
            <h4 class="sidebar-title">Table of Contents</h4>
            <ul class="sidebar-links">
                <li><a href="#stack-architecture" class="sidebar-link">Stack Architecture</a></li>
                <li><a href="#controller-variants" class="sidebar-link">Controller Variants</a></li>
                <li><a href="#api-patterns" class="sidebar-link">API Patterns</a></li>
                <li><a href="#le-audio" class="sidebar-link">LE Audio</a></li>
                <li><a href="#app-framework" class="sidebar-link">App Framework</a></li>
                <li><a href="#reference-apps" class="sidebar-link">Reference Applications</a></li>
                <li><a href="#prebuilt-libs" class="sidebar-link">Prebuilt Libraries</a></li>
            </ul>
        </nav>
    </aside>

    <article class="doc-content">
        <h1>BLE Development Guide</h1>
        <p>This guide covers BLE application development with the IPRO SDK's Bluetooth stack. The SDK uses the Zephyr BLE Host Stack paired with a RivieraWaves prebuilt controller, providing full BLE 5.4 support.</p>

        <!-- ============================================================ -->
        <!-- Stack Architecture -->
        <!-- ============================================================ -->
        <section id="stack-architecture">
            <h2>Stack Architecture</h2>
            <p>The BLE stack uses a Host + Controller dual-layer architecture, communicating through on-chip HCI (no UART HCI transport):</p>

            <div class="protocol-stack">
                <div class="stack-layer stack-green">
                    <div class="layer-name">Application Layer</div>
                    <div class="layer-detail">GAP / GATT Services / Profiles</div>
                </div>
                <div class="stack-layer stack-cyan">
                    <div class="layer-name">BLE Host (Zephyr-based)</div>
                    <div class="layer-detail">GAP / GATT / L2CAP / SMP / ISO</div>
                </div>
                <div class="stack-layer stack-amber">
                    <div class="layer-name">HCI (On-Chip)</div>
                    <div class="layer-detail">ipro_hci_wrapper</div>
                </div>
                <div class="stack-layer stack-red">
                    <div class="layer-name">BLE Controller (RivieraWaves)</div>
                    <div class="layer-detail">Link Layer / PHY (1M/2M/Coded)</div>
                </div>
            </div>

            <h3>Core Concepts</h3>
            <ul>
                <li><strong>Zephyr BLE Host</strong>: The Zephyr BLE Host Stack is used even on FreeRTOS. Applications interact through the standard <code>bt_*</code> APIs</li>
                <li><strong>RivieraWaves Controller</strong>: Provided as prebuilt static libraries, handling Link Layer and PHY management</li>
                <li><strong>On-Chip HCI</strong>: Host and Controller communicate via on-chip HCI, no UART HCI transport layer required</li>
                <li><strong>Callback-driven</strong>: All asynchronous events (connection, disconnection, notifications) are handled through callback functions</li>
            </ul>

            <h3>Source Code Structure</h3>
            <div class="code-block">
                <div class="code-block-header">
                    <span class="code-block-title">BLE Component Directory</span>
                </div>
                <pre><code>components/wireless/bluetooth/
├── blestack/                        # Zephyr BLE Host Stack (buildable source)
│   └── src/include/bluetooth/       # Public headers
│       ├── bluetooth.h              # bt_enable(), bt_le_adv_start()
│       ├── conn.h                   # bt_conn_create_le(), bt_conn_cb_register()
│       ├── gatt.h                   # bt_gatt_service_register(), bt_gatt_notify()
│       ├── uuid.h                   # BT_UUID_DECLARE_16() etc.
│       └── audio/                   # LE Audio APIs (BAP, CAP, VCP...)
├── btblecontroller/                 # RivieraWaves Controller source (requires license)
├── btblecontroller_ipro7_&lt;variant&gt;/ # Prebuilt controller static libraries
├── btprofile/                       # 20+ GATT Profile implementations
│   ├── bas/   dis/   hogp/          # Battery, Device Info, HID
│   ├── csip/  otp/   find/          # CSIP, OTP, Find Me
│   └── ...
├── blemesh/                         # Bluetooth Mesh support
├── ble_common.cmake                 # Controller variant configuration
└── build_all_prebuilts.sh           # Prebuilt library build script</code></pre>
            </div>
        </section>

        <!-- ============================================================ -->
        <!-- Controller Variants -->
        <!-- ============================================================ -->
        <section id="controller-variants">
            <h2>Controller Variants</h2>
            <p>The controller uses a unified connection pool architecture. In <code>linkN</code>, N represents the total simultaneous connection count. Each connection slot can be used as either Central or Peripheral (any role combination).</p>

            <h3>Available Variants</h3>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Variant</th>
                            <th>Max Links</th>
                            <th>BLE Version</th>
                            <th>LE Audio</th>
                            <th>Use Case</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>link1_periph</code></td>
                            <td>1</td>
                            <td>5.0+</td>
                            <td>No</td>
                            <td>Simple peripheral (minimal footprint)</td>
                        </tr>
                        <tr>
                            <td><code>link1</code></td>
                            <td>1</td>
                            <td>5.0+</td>
                            <td>No</td>
                            <td>Single connection, all roles</td>
                        </tr>
                        <tr>
                            <td><code>link2</code></td>
                            <td>2</td>
                            <td>5.0+</td>
                            <td>No</td>
                            <td>Dual connection (2C+0P, 1C+1P, 0C+2P)</td>
                        </tr>
                        <tr>
                            <td><code>link4</code></td>
                            <td>4</td>
                            <td>5.0+</td>
                            <td>No</td>
                            <td>Multi-connection applications</td>
                        </tr>
                        <tr>
                            <td><code>link8</code></td>
                            <td>8</td>
                            <td>5.0+</td>
                            <td>No</td>
                            <td>Hub / gateway</td>
                        </tr>
                        <tr>
                            <td><code>link1_leaudio</code></td>
                            <td>1</td>
                            <td>5.2</td>
                            <td>Yes</td>
                            <td>LE Audio peripheral</td>
                        </tr>
                        <tr>
                            <td><code>link2_leaudio</code></td>
                            <td>2</td>
                            <td>5.2</td>
                            <td>Yes</td>
                            <td>LE Audio with 2 links</td>
                        </tr>
                        <tr>
                            <td><code>link1_leaudio_53_54</code></td>
                            <td>1</td>
                            <td>5.4</td>
                            <td>Yes</td>
                            <td>Latest BLE + LE Audio</td>
                        </tr>
                        <tr>
                            <td><code>link2_leaudio_53_54</code></td>
                            <td>2</td>
                            <td>5.4</td>
                            <td>Yes</td>
                            <td>Latest BLE + LE Audio</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <h3>Kconfig Configuration</h3>
            <p>Select the controller variant in your application's <code>.config</code> via <code>CONFIG_BTBLECONTROLLER_LIB</code>:</p>
            <div class="code-block">
                <div class="code-block-header">
                    <span class="code-block-title">.config Variant Selection</span>
                    <button class="code-copy-btn"><i class="fas fa-copy"></i></button>
                </div>
                <pre><code class="language-bash"># Specify variant name directly
CONFIG_BTBLECONTROLLER_LIB="link2"

# Or use boolean flag composition (suffixes appended automatically)
CONFIG_BTBLECONTROLLER_LIB="link2"
CONFIG_BTBLECONTROLLER_LE_AUDIO=y     # Appends _leaudio
CONFIG_BTBLECONTROLLER_BT_54=y        # Appends _53_54 (5.4 implies 5.3)
# Resulting variant: link2_leaudio_53_54</code></pre>
            </div>

            <p>Prebuilt libraries are located at: <code>components/wireless/bluetooth/btblecontroller_ipro7_&lt;variant&gt;/</code></p>
        </section>

        <!-- ============================================================ -->
        <!-- API Patterns -->
        <!-- ============================================================ -->
        <section id="api-patterns">
            <h2>API Patterns</h2>
            <p>Applications use Zephyr-style callback-based BLE APIs. The legacy RivieraWaves <code>ke_msg</code> message passing mechanism is internal to the controller only and is not exposed to applications.</p>

            <h3>GAP: Advertising and Scanning</h3>
            <div class="code-block">
                <div class="code-block-header">
                    <span class="code-block-title">GAP Advertising Operations</span>
                    <button class="code-copy-btn"><i class="fas fa-copy"></i></button>
                </div>
                <pre><code class="language-c">#include &lt;bluetooth/bluetooth.h&gt;
#include &lt;bluetooth/conn.h&gt;

/* Advertising data */
static const struct bt_data ad[] = {
    BT_DATA_BYTES(BT_DATA_FLAGS,
                  BT_LE_AD_GENERAL | BT_LE_AD_NO_BREDR),
    BT_DATA_BYTES(BT_DATA_UUID16_ALL,
                  0x0d, 0x18),  /* Heart Rate Service */
};

static const struct bt_data sd[] = {
    BT_DATA(BT_DATA_NAME_COMPLETE, "IPRO Device", 11),
};

/* Start connectable advertising */
bt_le_adv_start(BT_LE_ADV_CONN_NAME,
                ad, ARRAY_SIZE(ad), sd, ARRAY_SIZE(sd));

/* Stop advertising */
bt_le_adv_stop();

/* Start scanning (Central role) */
bt_le_scan_start(BT_LE_SCAN_ACTIVE, scan_cb);</code></pre>
            </div>

            <h3>Connection Callbacks</h3>
            <div class="code-block">
                <div class="code-block-header">
                    <span class="code-block-title">Connection Management</span>
                    <button class="code-copy-btn"><i class="fas fa-copy"></i></button>
                </div>
                <pre><code class="language-c">static void connected(struct bt_conn *conn, u8_t err)
{
    if (err) {
        printk("Connection failed (err %u)\n", err);
        return;
    }
    printk("Connected\n");
}

static void disconnected(struct bt_conn *conn, u8_t reason)
{
    printk("Disconnected (reason %u)\n", reason);
}

static struct bt_conn_cb conn_callbacks = {
    .connected = connected,
    .disconnected = disconnected,
};

void app_init(void)
{
    bt_conn_cb_register(&amp;conn_callbacks);
    bt_enable(bt_ready);
}</code></pre>
            </div>

            <h3>GATT: Service Registration</h3>
            <div class="code-block">
                <div class="code-block-header">
                    <span class="code-block-title">Static GATT Service Definition</span>
                    <button class="code-copy-btn"><i class="fas fa-copy"></i></button>
                </div>
                <pre><code class="language-c">#include &lt;bluetooth/gatt.h&gt;
#include &lt;bluetooth/uuid.h&gt;

/* Custom UUIDs */
static struct bt_uuid_128 my_svc_uuid = BT_UUID_INIT_128(
    0xf0, 0xde, 0xbc, 0x9a, 0x78, 0x56, 0x34, 0x12,
    0x78, 0x56, 0x34, 0x12, 0x78, 0x56, 0x34, 0x12);

static struct bt_uuid_128 my_char_uuid = BT_UUID_INIT_128(
    0xf1, 0xde, 0xbc, 0x9a, 0x78, 0x56, 0x34, 0x12,
    0x78, 0x56, 0x34, 0x12, 0x78, 0x56, 0x34, 0x12);

static uint8_t my_value[256];

/* Read callback */
static ssize_t read_my_char(struct bt_conn *conn,
                            const struct bt_gatt_attr *attr,
                            void *buf, u16_t len, u16_t offset)
{
    return bt_gatt_attr_read(conn, attr, buf, len, offset,
                             my_value, sizeof(my_value));
}

/* Define service using macro (compile-time static registration) */
BT_GATT_SERVICE_DEFINE(my_svc,
    BT_GATT_PRIMARY_SERVICE(&amp;my_svc_uuid),
    BT_GATT_CHARACTERISTIC(&amp;my_char_uuid.uuid,
                           BT_GATT_CHRC_READ | BT_GATT_CHRC_NOTIFY,
                           BT_GATT_PERM_READ,
                           read_my_char, NULL, my_value),
    BT_GATT_CCC(NULL, BT_GATT_PERM_READ | BT_GATT_PERM_WRITE),
);

/* Send GATT notification */
bt_gatt_notify(conn, &amp;my_svc.attrs[1], my_value, sizeof(my_value));</code></pre>
            </div>

            <div class="alert alert-info">
                <strong>Note:</strong> The legacy <code>ipro_ble_api.h</code> and RivieraWaves <code>ke_msg</code> APIs are deprecated. All new applications should use the Zephyr <code>bt_*</code> APIs.
            </div>
        </section>

        <!-- ============================================================ -->
        <!-- LE Audio -->
        <!-- ============================================================ -->
        <section id="le-audio">
            <h2>LE Audio Ecosystem</h2>
            <p>The SDK supports comprehensive LE Audio functionality, requiring controller variants with the <code>_leaudio</code> suffix. Headers are located at <code>bluetooth/audio/</code>.</p>

            <h3>LE Audio Profiles</h3>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Profile</th>
                            <th>Full Name</th>
                            <th>Function</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>BAP</strong></td>
                            <td>Basic Audio Profile</td>
                            <td>Audio stream management (unicast/broadcast)</td>
                        </tr>
                        <tr>
                            <td><strong>CAP</strong></td>
                            <td>Common Audio Profile</td>
                            <td>Coordinated audio operations across device sets</td>
                        </tr>
                        <tr>
                            <td><strong>VCP</strong></td>
                            <td>Volume Control Profile</td>
                            <td>Volume control</td>
                        </tr>
                        <tr>
                            <td><strong>MCP</strong></td>
                            <td>Media Control Profile</td>
                            <td>Media playback control</td>
                        </tr>
                        <tr>
                            <td><strong>CSIP</strong></td>
                            <td>Coordinated Set Identification Profile</td>
                            <td>Coordinated device identification (e.g., left/right earbud pairing)</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <h3>LC3 Codec Pipeline</h3>
            <p>LE Audio uses LC3 (Low Complexity Communication Codec) as its mandatory codec, supporting 32-320 kbps bitrates with audio latency below 20ms. Audio data is transported over Isochronous Channels (CIS/BIS).</p>

            <h3>Configuration Example</h3>
            <div class="code-block">
                <div class="code-block-header">
                    <span class="code-block-title">.config LE Audio Configuration</span>
                    <button class="code-copy-btn"><i class="fas fa-copy"></i></button>
                </div>
                <pre><code class="language-bash"># Enable LE Audio controller
CONFIG_BTBLECONTROLLER_LIB="link2"
CONFIG_BTBLECONTROLLER_LE_AUDIO=y
CONFIG_BTBLECONTROLLER_BT_54=y
# Resulting variant: link2_leaudio_53_54

# Enable LE Audio Host features
CONFIG_BT_AUDIO=y
CONFIG_BT_BAP_UNICAST_SERVER=y
CONFIG_BT_ASCS=y
CONFIG_BT_PACS=y
CONFIG_BT_VCP_VOL_REND=y
CONFIG_BT_CSIP_SET_MEMBER=y</code></pre>
            </div>

            <div class="alert alert-info">
                <strong>Cross-reference:</strong> See the Audio &amp; Multimedia page for detailed audio pipeline documentation.
            </div>
        </section>

        <!-- ============================================================ -->
        <!-- App Framework -->
        <!-- ============================================================ -->
        <section id="app-framework">
            <h2>App Framework</h2>
            <p>BLE applications use the Mediator design pattern, decomposing complex Bluetooth functionality into reusable components:</p>

            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Component</th>
                            <th>Role</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Mediator</strong></td>
                            <td>Orchestrator</td>
                            <td>Manages interactions and lifecycle of Applets, controls overall application flow</td>
                        </tr>
                        <tr>
                            <td><strong>Applets</strong></td>
                            <td>Reusable components</td>
                            <td>Encapsulate specific functionality (e.g., advertising management, GATT services, audio streams), shareable across applications</td>
                        </tr>
                        <tr>
                            <td><strong>Intermediaries</strong></td>
                            <td>Protocol bridges</td>
                            <td>Convert data formats between protocol layers, e.g., translating application-level commands into BLE GAP/GATT operations</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <p>This framework is primarily used in LE Audio applications (GAF, BAP, VCP, MCP, CAP) to modularize complex audio management logic.</p>
        </section>

        <!-- ============================================================ -->
        <!-- Reference Applications -->
        <!-- ============================================================ -->
        <section id="reference-apps">
            <h2>Reference Applications</h2>
            <p>The SDK provides several BLE reference applications covering common Bluetooth use cases:</p>

            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Application</th>
                            <th>Description</th>
                            <th>Controller Variant</th>
                            <th>Path</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>ipro_ble_remote</strong></td>
                            <td>GATT services + OTA update, 6 services, image transfer at 101 KB/s</td>
                            <td>link2</td>
                            <td><code>apps/bluetooth/ipro_ble_remote/</code></td>
                        </tr>
                        <tr>
                            <td><strong>ipro_throughput_test</strong></td>
                            <td>Throughput benchmark, up to 999 Kbps, native Zephyr bt_* API, Master/Slave roles</td>
                            <td>link2</td>
                            <td><code>apps/bluetooth/ipro_throughput_test/</code></td>
                        </tr>
                        <tr>
                            <td><strong>ipro_ble_transparent</strong></td>
                            <td>UART transparent bridge, bidirectional BLE-to-serial passthrough</td>
                            <td>link1</td>
                            <td><code>apps/bluetooth/ipro_ble_transparent/</code></td>
                        </tr>
                        <tr>
                            <td><strong>ipro_ble_hid_keyboard</strong></td>
                            <td>HOGP HID keyboard using HID over GATT Profile</td>
                            <td>link1_periph</td>
                            <td><code>apps/bluetooth/ipro_ble_hid_keyboard/</code></td>
                        </tr>
                        <tr>
                            <td><strong>ipro_le_audio_headset</strong></td>
                            <td>GAF/BAP unicast audio headset with VCP and CSIP support</td>
                            <td>link2_leaudio_53_54</td>
                            <td><code>apps/bluetooth/ipro_le_audio_headset/</code></td>
                        </tr>
                        <tr>
                            <td><strong>ipro_walkie_talkie</strong></td>
                            <td>BIS LE Audio broadcast walkie-talkie</td>
                            <td>link2_leaudio</td>
                            <td><code>apps/bluetooth/ipro_walkie_talkie/</code></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- ============================================================ -->
        <!-- Prebuilt Library Workflow -->
        <!-- ============================================================ -->
        <section id="prebuilt-libs">
            <h2>Prebuilt Libraries</h2>
            <p>The BLE controller is provided as prebuilt static libraries. <code>CONFIG_BLE_FORCE_SOURCE_BUILD</code> cannot be used in release builds.</p>

            <h3>Build Script</h3>
            <div class="code-block">
                <div class="code-block-header">
                    <span class="code-block-title">Building Prebuilt Libraries</span>
                    <button class="code-copy-btn"><i class="fas fa-copy"></i></button>
                </div>
                <pre><code class="language-bash"># Build a specific variant
components/wireless/bluetooth/build_all_prebuilts.sh link2

# Build all variants
components/wireless/bluetooth/build_all_prebuilts.sh all

# Output location
# btblecontroller_ipro7_link2/libbtblecontroller_ipro7_link2.a</code></pre>
            </div>

            <h3>Source Build for Development</h3>
            <div class="code-block">
                <div class="code-block-header">
                    <span class="code-block-title">.config Enable Source Build (Development Only)</span>
                    <button class="code-copy-btn"><i class="fas fa-copy"></i></button>
                </div>
                <pre><code class="language-bash"># Development and debugging only, not for release
CONFIG_BLE_FORCE_SOURCE_BUILD=y</code></pre>
            </div>

            <div class="alert alert-warning">
                <strong>Important:</strong> <code>CONFIG_BLE_FORCE_SOURCE_BUILD</code> is for development and debugging only. It cannot be used in release builds. Production releases must use prebuilt static libraries.
            </div>

            <h3>Library Locations</h3>
            <p>Prebuilt libraries are stored under <code>components/wireless/bluetooth/</code> with the naming pattern:</p>
            <div class="code-block">
                <div class="code-block-header">
                    <span class="code-block-title">Prebuilt Library Directories</span>
                </div>
                <pre><code>btblecontroller_ipro7_link1/
btblecontroller_ipro7_link1_periph/
btblecontroller_ipro7_link2/
btblecontroller_ipro7_link4/
btblecontroller_ipro7_link8/
btblecontroller_ipro7_link1_leaudio/
btblecontroller_ipro7_link2_leaudio/
btblecontroller_ipro7_link1_leaudio_53_54/
btblecontroller_ipro7_link2_leaudio_53_54/
...</code></pre>
            </div>
        </section>
    </article>
</div>
